collectors:
  docker:
    enabled: false
  containerd:
    socket: /run/k3s/containerd/containerd.sock
falco: 
  grpc_output:
    enabled: true
falcosidekick: 
  enabled: true 
  config:
    rabbitmq:
      url: amqp://ztrke2:ztrke2@10.1.1.241:5673
      queue: "events"
tty: true 

customRules:
  falco-test.yaml: |-
    - list: http-l
      items: [setgid, shutdown, brk, prctl, rt_sigreturn, 
            capget, epoll_ctl, exit_group, execve, madvise, 
            munmap, newfstatat, sysinfo, unshare, rt_sigprocmask, 
            setitimer, ioctl, symlinkat, close_range, getpid, 
            prlimit64, unlinkat, getuid, fcntl, access, 
            fchownat, fstatfs, sigaltstack, tgkill, chdir, 
            getegid, getsockname, setsid, mkdirat, rseq, 
            gettid, keyctl, pread64, umount2, getcwd, 
            connect, dup3, epoll_create1, unlink, getppid, 
            lseek, socket, select, write, epoll_pwait, 
            geteuid, getgid, ppoll, recvmsg, sched_getaffinity, 
            read, rt_sigaction, arch_prctl, futex, setgroups, 
            mprotect, nanosleep, recvfrom, faccessat2, getrlimit, 
            mount, getdents64, pipe2, statfs, sched_yield, 
            set_robust_list, set_tid_address, umask, openat, capset, 
            listen, readlinkat, getrandom, mknodat, mmap, 
            setuid, accept, lstat, sendto, fchdir, 
            clone, pivot_root, setsockopt, close, fstat, 
            stat, bind ]

    - list: sql-l
      items: [pwrite64, capset, rt_sigreturn, setuid, prctl, 
            getpgrp, getpid, mprotect, shutdown, io_setup, 
            nanosleep, sysinfo, getcwd, connect, fstatfs, 
            rename, write, statfs, unlink, futex, 
            rt_sigprocmask, chdir, getpriority, madvise, tgkill, 
            io_submit, sendto, socket, newfstatat, arch_prctl, 
            umask, getrusage, geteuid, lseek, poll, 
            eventfd2, setpriority, symlinkat, munmap, clone3, 
            epoll_wait, getppid, getuid, sched_yield, exit, 
            sigaltstack, bind, epoll_create1, fcntl, epoll_ctl, 
            pipe2, prlimit64, uname, exit_group, ppoll, 
            readlink, set_robust_list, setsockopt, dup2, epoll_pwait, 
            setgroups, fallocate, fsync, ioctl, mkdir, 
            gettid, getegid, clock_gettime, getpeername, getdents64, 
            getgroups, renameat, rt_sigtimedwait, sched_setaffinity, read, 
            fchdir, accept, faccessat2, rt_sigaction, clone, 
            execve, getrandom, set_tid_address, times, fdatasync, 
            openat, pread64, rseq, access, sched_getaffinity, 
            brk, getgid, pipe, setgid, wait4, 
            io_getevents, clock_nanosleep, mmap, fstat, close, 
            recvfrom, capget, dup, fadvise64, listen ]

    - list: ssh-l
      items: [close_range, dup2, getpeername, uname, alarm, 
            clone, getgid, poll, rseq, setpriority, 
            socketpair, statfs, accept, bind, epoll_ctl, 
            read, clone3, getpid, keyctl, pipe2, 
            ppoll, statx, chroot, getcwd, brk, 
            connect, mkdir, vfork, clock_nanosleep, getppid, 
            getegid, geteuid, getpriority, execve, futex, 
            set_robust_list, setresuid, setsid, epoll_pwait, tgkill, 
            newfstatat, readlink, getuid, setsockopt, socket, 
            arch_prctl, chdir, recvfrom, rt_sigprocmask, rt_sigreturn, 
            ftruncate, lseek, ioctl, openat, prlimit64, 
            recvmsg, set_tid_address, wait4, fstat, getrandom, 
            listen, nanosleep, getpgrp, getsockopt, pread64, 
            rename, setresgid, write, access, faccessat2, 
            setgid, sendto, setuid, umask, fstatfs, 
            mprotect, prctl, getsockname, mmap, rt_sigaction, 
            setgroups, capget, capset, close, getdents64, 
            getgroups, munmap, exit_group, fcntl ]

    - rule: http-r 
      desc: notice abnormal syscall in http
      condition: > 
        syscall.type != null and
        not syscall.type in (http-l) and evt.dir = >
        and container.id != host and 
        container.name = "http" and 
        container.duration > 60000000000
      output: > 
        | http | %container.image | %k8s.pod.name | %proc.pid
        |SYSCALLTYPE %syscall.type DONE| %container.duration | %evt.rawtime.s
        | %evt.rawtime.ns | %evt.rawtime
      priority: ALERT


    - rule: sql-r 
      desc: notice abnormal syscall in sql
      condition: > 
        syscall.type != null and
        not syscall.type in (sql-l) and evt.dir = >
        and container.id != host and 
        container.name = "sql" and 
        container.duration > 60000000000
      output: > 
        | sql | %container.image | %k8s.pod.name | %proc.pid
        |SYSCALLTYPE %syscall.type DONE| %container.duration | %evt.rawtime.s
        | %evt.rawtime.ns | %evt.rawtime
      priority: ALERT


    - rule: ssh-r 
      desc: notice abnormal syscall in ssh
      condition: > 
        syscall.type != null and
        not syscall.type in (ssh-l) and evt.dir = >
        and container.id != host and 
        container.name = "ssh" and 
        container.duration > 60000000000
      output: > 
        | ssh | %container.image | %k8s.pod.name | %proc.pid
        |SYSCALLTYPE %syscall.type DONE| %container.duration | %evt.rawtime.s
        | %evt.rawtime.ns | %evt.rawtime
      priority: ALERT

